<script>
  Alpine.store('projectPath', {
    path: '',
    currentBranch: ''
  });

  Alpine.data('projectPath', () => ({
    historyProjectPaths: [],
    lastSelectedPath: '',
    branches: [],
    ftpConfig: {},
    ftpDefaultPort: 21,
    savedFtpConfig: null,

    get selectProjectPathFlag() {
      return '%SELECT%';
    },

    async init() {
      this.savedFtpConfig = window.electronStore.get('ftp');

      window.gitAPI.onProgress('files.sync.progress', (event, data) => {
        let statusText = '';
        if (data.type === 'connected') {
          statusText = '';
        } else if (data.type === 'error') {
          if (data.sourcePath) statusText += '同步 ' + data.sourcePath + ' 出错: ';
          statusText += data.message;
          this.showError(statusText);
        } else if (data.message) {
          statusText += data.message;
        } else if (data.sourcePath) {
          statusText += '文件 ' + data.sourcePath + ' 已同步';
        }
        Alpine.store('statusBar').statusText = statusText;
      });
      window.electronAPI.receive('manage-projects.closed', (event, ...paths) => {
        disableBody(false);

        const selectedPath = Alpine.store('projectPath').path;
        Alpine.store('projectPath').path = '';
        this.historyProjectPaths = paths;
        window.electronStore.set('historyProjectPaths', paths.join(';'));

        this.$nextTick(()=>{
          if (paths.length === 0) {
            this.lastSelectedPath = '';
            this.clearAllList();
            window.electronStore.delete('projectPath');
          } else if (!paths.includes(selectedPath)) {
            Alpine.store('projectPath').path = this.lastSelectedPath = paths[0];
            this.refresh();
            window.electronStore.set('projectPath', paths[0]);
          } else {
            Alpine.store('projectPath').path = selectedPath;
          }
        });
      });
      this.$watch('$store.projectPath.path', path => {
        if(path){
          this.ftpConfig = (this.savedFtpConfig && typeof this.savedFtpConfig[path] === 'object') ? Object.assign({}, this.savedFtpConfig[path]) : {};
        }
      });
      this.$watch('ftpConfig.protocol', protocol => {
        this.ftpDefaultPort = protocol === 'sftp' ? 22 : 21;
      });

      let paths = window.electronStore.get('historyProjectPaths');
      if(paths){
        paths = paths.split(';').filter(p => p && p !== this.selectProjectPathFlag);
        this.historyProjectPaths = paths;
        await this.$nextTick();// 等待渲染好 DOM 后再继续
      }

      let path = window.electronStore.get('projectPath') || (this.historyProjectPaths[0] ?? '');
      if (path === this.selectProjectPathFlag) path = '';

      Alpine.store('projectPath').path = this.lastSelectedPath = path;

      document.addEventListener('componentsLoaded', () => {
        if(path){
          this.refresh();
        }
        if (path && this.savedFtpConfig && typeof this.savedFtpConfig[path] === 'object' && this.savedFtpConfig[path].autoSync && this.savedFtpConfig[path].host) {
          window.electronAPI.startSyncFiles(path, 'files.sync.progress').then(result => {
            Alpine.store('statusBar').statusText = result ? '正在监听文件变更并同步到远程服务器...' : '启动文件同步失败，已停止自动同步。';
          });
        } else {
          window.electronAPI.stopSyncFiles();
        }
      });
    },

    selectProjectPath(event) {
      if (isDisabledBody()) {
        Alpine.store('projectPath').path = this.lastSelectedPath;
        return;
      }

      const selectedValue = event.target.value;

      if (selectedValue === this.selectProjectPathFlag) {
        disableBody(true);
        window.electronAPI.openDirectory(this.lastSelectedPath).then((result) => {
          if (result) {
            if(!this.historyProjectPaths.includes(result)){
              this.historyProjectPaths.unshift(result);
            }

            Alpine.store('projectPath').path = result;

            disableBody(false);
            this.refresh(() => {
              // 提供的路径如果是有效的，则更新这次选择的路径
              this.lastSelectedPath = result;
              window.electronStore.set('projectPath', result);

              let paths = window.electronStore.get('historyProjectPaths');
              paths = paths ? paths.split(';') : [];
              if(!paths.includes(result)){
                paths.unshift(result);
                window.electronStore.set('historyProjectPaths', paths.join(';'));
              }
            });
          } else {
            Alpine.store('projectPath').path = this.lastSelectedPath;
            window.electronStore.set('projectPath', this.lastSelectedPath);
          }
        })
        .finally(() => {
          disableBody(false);
        });
      } else if (selectedValue) {
        Alpine.store('projectPath').path = selectedValue;
        this.refresh(() => {
          // 提供的路径如果是有效的，则更新这次选择的路径
          this.lastSelectedPath = selectedValue;
          window.electronStore.set('projectPath', selectedValue);
        });
      }
    },

    manageProjects() {
      disableBody(true);
      window.electronAPI.showProjectsDialog(...this.historyProjectPaths);
    },

    switchBranch(event) {
      if(isDisabledBody()) return;

      clearMessages();
      let branch = event.target.value;
      if (!branch) {
        showError('请选择分支');
        return;
      }
      disableBody(true);
      window.gitAPI.switchBranch(Alpine.store('projectPath').path, branch)
        .then(() => {
          disableBody(false);
          this.refresh();
          showSuccess('已成功切换到 '+ branch + ' 分支');
        })
        .catch((error) => {
          disableBody(false);
          this.showError(error.message);
        });
    },

    showFtpConfig() {
      const path = Alpine.store('projectPath').path;
      if (!path) {
        showError('项目路径不能为空');
        return;
      }

      this.ftpConfig = (this.savedFtpConfig && typeof this.savedFtpConfig[path] === 'object') ? Object.assign({}, this.savedFtpConfig[path]) : {};
      this.ftpConfig.autoSync ??= false;
      this.ftpConfig.ignoredPaths ??= '**/node_modules/**\n**/.git/**\n**/.DS_Store**';
      document.getElementById('ftp-config-dialog').showModal();
    },

    saveFtpConfig() {
      const path = Alpine.store('projectPath').path;
      if(!path){
        showError('项目路径不能为空');
        return;
      }

      let savedConfig = window.electronStore.get('ftp');
      if (this.ftpConfig.host) {
        savedConfig = (savedConfig && typeof savedConfig === 'object') ? savedConfig : {};
        savedConfig[path] = Object.assign({}, this.ftpConfig);

        if (savedConfig[path].autoSync) {
          window.electronAPI.startSyncFiles(path, 'files.sync.progress').then(result => {
            Alpine.store('statusBar').statusText = result ? '正在监听文件变更并同步到远程服务器...' : '启动文件同步失败，已停止自动同步。';
          });
        } else {
          window.electronAPI.stopSyncFiles().then(result => {
            Alpine.store('statusBar').statusText = result ? '已停止文件自动同步' : '';
          });
        }
      } else if (savedConfig && typeof savedConfig === 'object' && typeof savedConfig[path] !== 'undefined') {
        window.electronAPI.stopSyncFiles().then(result => {
          Alpine.store('statusBar').statusText = result ? '已停止文件自动同步' : '';
        });
        delete savedConfig[path];
      }

      this.savedFtpConfig = savedConfig;
      window.electronStore.setJSON('ftp', JSON.stringify(savedConfig));
      showSuccess('已成功保存FTP设置');

      document.getElementById('ftp-config-dialog').close();
    },

    closeFtpConfig() {
      const path = Alpine.store('projectPath').path;
      this.ftpConfig = (path && this.savedFtpConfig && typeof this.savedFtpConfig[path] === 'object') ? Object.assign({}, this.savedFtpConfig[path]) : {};
      document.getElementById('ftp-config-dialog').close();
    },
  }));
</script>
<div x-data="projectPath">
  <div class="flex gap-2">
    <label class="select grow">
      <span class="label whitespace-nowrap"><svg x-show="historyProjectPaths.length>0" x-on:click="manageProjects" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 18 18" stroke-width="1.5" stroke="currentColor" class="size-4 cursor-pointer">
          <path stroke-linecap="round" stroke-linejoin="round" d="M0 3h18M0 9h18M0 15h18" />
        </svg>项目路径</span>
      <select x-model="$store.projectPath.path" x-on:change="selectProjectPath">
        <template x-if="!historyProjectPaths.length">
          <option value="" selected></option>
        </template>
        <template x-for="path in historyProjectPaths">
          <option x-bind:value="path" x-text="path"></option>
        </template>
        <option x-bind:value="selectProjectPathFlag">选择项目文件夹...</option>
      </select>
    </label>
    <label class="shrink-0 select w-auto">
      <span class="label whitespace-nowrap">当前分支</span>
      <select x-model="$store.projectPath.currentBranch" x-on:change="switchBranch" class="w-auto">
        <template x-for="branch in branches">
          <option x-bind:value="branch.value" x-text="branch.label"></option>
        </template>
      </select>
    </label>
    <button class="btn shrink-0" x-on:click="showFtpConfig" x-bind:class="ftpConfig.host ? 'btn-success' : ''">远程服务器</button>
  </div>

  <dialog id="ftp-config-dialog" class="modal modal-bottom sm:modal-middle">
    <div class="modal-box">
      <h3 class="text-lg font-bold">FTP设置</h3>
      <div class="py-4">
        <label class="select my-1 w-auto">
          <span class="label">协议</span>
          <select x-model="ftpConfig.protocol">
            <option value="ftp">FTP</option>
            <option value="sftp">SFTP</option>
          </select>
        </label>
        <label class="input my-1 w-full">
          <span class="label">主机</span>
          <input type="text" placeholder="127.0.0.1" x-model="ftpConfig.host" />
        </label>
        <label class="input my-1 w-35">
          <span class="label">端口</span>
          <input type="text" :placeholder="ftpDefaultPort" x-model.number="ftpConfig.port" />
        </label>
        <label class="input my-1 w-full">
          <span class="label">用户名</span>
          <input type="text" x-model="ftpConfig.username" />
        </label>
        <label class="input my-1 w-full">
          <span class="label">密码</span>
          <input type="password" x-model="ftpConfig.password" />
        </label>
        <label class="input my-1 w-full">
          <span class="label">远程路径</span>
          <input type="text" placeholder="/" x-model="ftpConfig.remotePath" />
        </label>
        <label class="label my-1">
          <input type="checkbox" x-model="ftpConfig.autoSync" class="toggle toggle-primary" />
          自动同步到远程服务器
        </label>
        <fieldset class="fieldset my-1 w-full" x-show="ftpConfig.autoSync">
          <legend class="fieldset-legend">以下路径不自动同步</legend>
          <textarea class="textarea w-full h-21" x-model="ftpConfig.ignoredPaths"></textarea>
          <div class="label">多个路径请用换行分隔</div>
        </fieldset>
      </div>
      <div class="modal-action">
        <button class="btn" x-on:click="closeFtpConfig">取消</button>
        <button class="btn btn-primary" x-on:click="saveFtpConfig">保存</button>
      </div>
    </div>
  </dialog>
</div>